<!DOCTYPE HTML>
<html lang="en">
	<head>
		<title>GoogleSheetsDB - Alexandre ZANNI</title>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=yes" />
		<link rel="stylesheet" href="assets/css/style.css" />
		<noscript><link rel="stylesheet" href="assets/css/noscript.css" /></noscript>
	</head>

		<input type="text" id="inputSearch" onkeyup="searchTable('inputSearch','tableFruitsAndVegetables')" placeholder="Chercher par nom..." title="Type in a name">
		<select id="selectSearchStringTable"></select>

		<input type="text" id="inputBinaryOperator" onkeyup="searchBinaryOperatorTable('inputBinaryOperator','tableFruitsAndVegetables')" placeholder="Chercher par valeur..." title="Type in a name">
		<select id="selectedBinaryOperator">
			<option value="0"><</option>
			<option value="1"><=</option>
			<option value="2">=</option>
			<option value="3">></option>
			<option value="3">>=</option>
		</select>

		<select id="selectBinaryOperatorTable"></select>

		<div id="tableFruitsAndVegetables" class="table-wrapper"></div>

			<script>
			// ex URL publique : https://jsonplaceholder.typicode.com/todos/1

			var tab_name = 'FruitsAndVegetables';
			var spreadsheet_id = '1--6J7INOfcWZ0sUVJAlIzgxMuaZXoCnPfatQSVgiJMw';
			var api_key = 'AIzaSyBlrDnOY8VVaUMm_39N3kJtiwhvTrI5PvE';
			var url = 'https://sheets.googleapis.com/v4/spreadsheets/' +
			           spreadsheet_id + '/values/' + tab_name +
			           '?alt=json&key=' + api_key;
			console.log(url);

			function loadJSON(callback) {
				 var xobj = new XMLHttpRequest();
						 xobj.overrideMimeType("application/json");
				 xobj.open('GET', url, true); // Replace 'my_data' with the path to your file
				 xobj.onreadystatechange = function () {
							 if (xobj.readyState == 4 && xobj.status == "200") {
								 // Required use of an anonymous callback as .open will NOT return a value but simply returns undefined in asynchronous mode
								 callback(xobj.responseText);
							 }
				 };
				 xobj.send(null);
		 }

			 loadJSON(function(response) {
			  // Parse JSON string into object
			    var actual_JSON = JSON.parse(response);
					realJSON = actual_JSON.values;
					// console.log(response);
					// console.log(realJSON);
					importJsonGoogleSheetsData(realJSON, 'tableFruitsAndVegetables');
			 });

			 function importJsonGoogleSheetsData(list, tableId) {
            var cols = [];

            for (var i = 0; i < list.length; i++) {
                for (var k in list[i]) {
                    if (cols.indexOf(k) === -1) {
                        // Push all keys to the array
                        cols.push(k);
                    }
                }
            }

            // Create a table element
            var table = document.createElement("table");
						table.setAttribute("class", "sortable");
						table.setAttribute("border", "1px solid black");
						table.setAttribute("id", "tableData");

            // Create theader
					 var thead = document.createElement("thead");
					 var tr = table.appendChild(thead);
					 var selectSearch = document.getElementById("selectSearchStringTable");
					 var selectBinaryOperator = document.getElementById("selectBinaryOperatorTable");
					 var options = [];

            for (var i = 0; i < cols.length; i++) {
                // Create the table header th element
                var theader = document.createElement("th");
								// theader.innerHTML = list[0][0];
                theader.innerHTML = list[0][i];
								var optionSelectSearch = new Option(theader.innerHTML, i);
								selectSearch.appendChild(optionSelectSearch);
								var optionSelectBinaryOperator = new Option(theader.innerHTML, i);
								selectBinaryOperator.appendChild(optionSelectBinaryOperator);

                // Append columnName to the table row
                tr.appendChild(theader);
            }

            // Adding the data to the table
            for (var i = 1; i < list.length; i++) {
                // Create a new row
                trow = table.insertRow(-1);
                for (var j = 0; j < cols.length; j++) {
                    var cell = trow.insertCell(-1);
                    // Inserting the cell at particular place
                    cell.innerHTML = list[i][cols[j]];
                }
            }

            // Add the newly created table containing json data
            var el = document.getElementById(tableId);
            el.innerHTML = "";
            el.appendChild(table);
        }

				function selectTable(selectId) {
					var columnSearchId = document.getElementById(selectId).value;
					return columnSearchId;
				}

				function searchTable(input,table) {
					var columnSearchId = selectTable("selectSearchStringTable");
				  var trValues = document.getElementById("tableData").getElementsByTagName("tbody")[0].rows; // TODO
				  var input, filter, table, tr, td, i, txtValue;
				  input = document.getElementById(input);
				  filter = input.value.toUpperCase();
				  table = document.getElementById(table);
				  tr = table.getElementsByTagName("tr");
				  for (i = 0; i < tr.length; i++) {
				    td = tr[i].getElementsByTagName("td")[columnSearchId];
				    if (td) {
				      txtValue = td.textContent || td.innerText;
				      if (txtValue.toUpperCase().indexOf(filter) > -1) {
				        tr[i].style.display = "";
				      } else {
				        tr[i].style.display = "none";
				      }
				    }
				  }
				}

				function searchBinaryOperatorTable(input,table) {
					var columnSearchId = selectTable("selectBinaryOperatorTable");
					var binaryOperatorId = selectTable("selectedBinaryOperator");
				  var input, table, tr, td, i, txtValue;

				  if (binaryOperatorId == 0) {
				    binaryOperator = '<';
				  } else if (binaryOperatorId == 1) {
				      binaryOperator = '<=';
				  }  else if (binaryOperatorId == 2) {
				      binaryOperator = '=';
				  } else if (binaryOperatorId == 3) {
				      binaryOperator = '>';
				  } else if (binaryOperatorId == 4) {
				      binaryOperator = '>=';
				  }

				  input = document.getElementById(input);
				  table = document.getElementById(table);
				  tr = table.getElementsByTagName("tr");
				  for (i = 0; i < tr.length; i++) {
				    td = tr[i].getElementsByTagName("td")[columnSearchId];
				    if (td) {
				      txtValue = td.textContent || td.innerText;
				        if (binaryOperator == '<') {
				            if ((txtValue*1 < input.value*1) || ( input.value == "" ) ) {
				                tr[i].style.display = "";
				            } else {
				                tr[i].style.display = "none";
				            }
				        } else if (binaryOperator == '<=') {
				            if ((txtValue*1 <= input.value*1) || ( input.value == "" ) ) {
				                tr[i].style.display = "";
				            } else {
				                tr[i].style.display = "none";
				            }
				        } else if (binaryOperator == '=') {
				            if ((txtValue*1 == input.value*1) || ( input.value == "" ) ) {
				                tr[i].style.display = "";
				            } else {
				                tr[i].style.display = "none";
				            }
				        } else if (binaryOperator == '>') {
				            if ((txtValue*1 > input.value*1) || ( input.value == "" ) ) {
				                tr[i].style.display = "";
				            } else {
				                tr[i].style.display = "none";
				            }
				        } else if (binaryOperator == '>=') {
				            if ((txtValue*1 >= input.value*1) || ( input.value == "" ) ) {
				                tr[i].style.display = "";
				            } else {
				                tr[i].style.display = "none";
				            }
				        }
				    }
				  }
				}

			</script>
			<script src="assets/js/sorttable.js"></script>

	</body>
</html>
